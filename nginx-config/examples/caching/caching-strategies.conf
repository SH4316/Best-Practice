# 캐싱 전략 설정 예제

# 1. 기본 브라우저 캐싱 설정
server {
    listen 80;
    server_name browser-cache.example.com;
    root /var/www/html;
    
    # 정적 파일 캐싱 (1년)
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # HTML 파일 캐싱 (1시간)
    location ~* \.(html)$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
    
    # API 응답 캐싱 (5분)
    location /api/ {
        expires 5m;
        add_header Cache-Control "public, must-revalidate";
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 기타 파일
    location / {
        try_files $uri $uri/ =404;
    }
}

# 2. 조건부 캐싱 설정
server {
    listen 80;
    server_name conditional-cache.example.com;
    root /var/www/html;
    
    # 쿼리 문자열이 있는 파일은 캐싱하지 않음
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg)$ {
        if ($args) {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # 개발 환경에서는 캐싱 비활성화
    location ~* \.(css|js)$ {
        if ($http_cookie ~* "dev_mode=on") {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            break;
        }
        
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 3. 기본 프록시 캐싱 설정
http {
    # 프록시 캐시 경로 설정
    proxy_cache_path /var/nginx/cache levels=1:2 keys_zone=api_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    server {
        listen 80;
        server_name proxy-cache.example.com;
        
        location /api/data {
            # 캐시 활성화
            proxy_cache api_cache;
            
            # 캐시 키 설정
            proxy_cache_key "$scheme$request_method$host$request_uri";
            
            # 캐시 유효기간 설정
            proxy_cache_valid 200 5m;    # 성공 응답은 5분
            proxy_cache_valid 404 1m;    # 404는 1분
            proxy_cache_valid any 1m;    # 기타 응답은 1분
            
            # 캐시 관련 헤더
            add_header X-Proxy-Cache $upstream_cache_status;
            
            # 백엔드 서버 설정
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

# 4. 고급 프록시 캐싱 설정
http {
    # 다중 캐시 영역 설정
    proxy_cache_path /var/nginx/cache/api levels=1:2 keys_zone=api_cache:10m 
                     max_size=2g inactive=60m use_temp_path=off;
    proxy_cache_path /var/nginx/cache/static levels=1:2 keys_zone=static_cache:10m 
                     max_size=5g inactive=24h use_temp_path=off;
    
    # 캐시 키 맵 설정
    map $request_method $cache_key_method {
        GET $request_method;
        HEAD $request_method;
        default "";
    }
    
    server {
        listen 80;
        server_name advanced-cache.example.com;
        
        # 정적 리소스 캐싱
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf)$ {
            proxy_cache static_cache;
            proxy_cache_key "$scheme$cache_key_method$host$request_uri";
            proxy_cache_valid 200 7d;
            proxy_cache_valid 404 1h;
            
            # 캐시 우회 조건
            proxy_cache_bypass $http_pragma $http_authorization;
            proxy_no_cache $http_pragma $http_authorization;
            
            add_header X-Proxy-Cache $upstream_cache_status;
            
            # 정적 파일은 직접 서빙
            try_files $uri =404;
        }
        
        # API 캐싱
        location /api/ {
            proxy_cache api_cache;
            proxy_cache_key "$scheme$cache_key_method$host$request_uri";
            proxy_cache_valid 200 5m;
            proxy_cache_valid 404 1m;
            
            # POST 요청도 캐싱 (읽기 전용 API의 경우)
            proxy_cache_methods GET HEAD POST;
            
            # 캐시 우바이 조건
            proxy_cache_bypass $http_pragma $http_authorization $cookie_nocache;
            proxy_no_cache $http_pragma $http_authorization $cookie_nocache;
            
            add_header X-Proxy-Cache $upstream_cache_status;
            
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 동적 콘텐츠 (캐싱 안 함)
        location /dynamic/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

# 5. FastCGI 캐싱 설정
http {
    # FastCGI 캐시 경로 설정
    fastcgi_cache_path /var/nginx/fastcgi_cache levels=1:2 keys_zone=fastcgi_cache:100m 
                       max_size=2g inactive=60m use_temp_path=off;
    
    # FastCGI 캐시 키 설정
    fastcgi_cache_key "$scheme$request_method$host$request_uri";
    
    server {
        listen 80;
        server_name fastcgi-cache.example.com;
        root /var/www/php-app;
        index index.php;
        
        # 동적 콘텐츠 캐싱
        location ~ \.php$ {
            # FastCGI 서버 설정
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            
            # FastCGI 캐싱
            fastcgi_cache fastcgi_cache;
            fastcgi_cache_valid 200 10m;
            fastcgi_cache_valid 404 1m;
            
            # 캐시 우바이 조건
            fastcgi_cache_bypass $cookie_nocache $arg_nocache;
            fastcgi_no_cache $cookie_nocache $arg_nocache;
            
            # 캐시 헤더
            add_header X-FastCGI-Cache $upstream_cache_status;
        }
        
        # 정적 파일
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }
    }
}

# 6. 파일명 기반 캐시 무효화
server {
    listen 80;
    server-name cache-invalidation.example.com;
    root /var/www/html;
    
    # 해시를 포함한 파일명 자동 리라이트
    location ~* \.(css|js)$ {
        # file.abc123.css -> file.css
        rewrite ^(.+)\.([a-f0-9]{8,})\.(css|js)$ $1.$3 last;
        
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 7. API 캐시 무효화
http {
    proxy_cache_path /var/nginx/cache/api levels=1:2 keys_zone=api_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    server {
        listen 80;
        server_name api-invalidation.example.com;
        
        # GET 요청 캐싱
        location /api/data {
            proxy_cache api_cache;
            proxy_cache_key "$scheme$request_method$host$request_uri";
            proxy_cache_valid 200 5m;
            
            add_header X-Proxy-Cache $upstream_cache_status;
            
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # POST/PUT/DELETE 요청 처리 (캐시 무효화)
        location /api/data {
            if ($request_method ~ ^(POST|PUT|DELETE)$) {
                # 캐시 무효화 스크립트 호출
                # 이 부분은 Lua 스크립트나 외부 프로그램으로 구현 가능
                proxy_pass http://backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # 응답 후 캐시 정리
                add_header X-Cache-Invalidated "true";
                break;
            }
        }
        
        # 캐시 정리 API
        location /admin/cache-clear {
            allow 127.0.0.1;
            deny all;
            
            # 캐시 디렉토리 정리
            # 이 부분은 스크립트로 구현 필요
            return 200 "Cache cleared";
        }
    }
}

# 8. 캐시 성능 모니터링
http {
    proxy_cache_path /var/nginx/cache/api levels=1:2 keys_zone=api_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    server {
        listen 80;
        server_name cache-monitoring.example.com;
        
        location /api/data {
            proxy_cache api_cache;
            proxy_cache_key "$scheme$request_method$host$request_uri";
            proxy_cache_valid 200 5m;
            
            # 캐시 상태 헤더 추가
            add_header X-Proxy-Cache $upstream_cache_status;
            add_header X-Cache-Key "$scheme$request_method$host$request_uri";
            
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 캐시 통계 API
        location /cache-status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
    }
}